# 医疗 RAG 系统 - 项目架构说明

## 一、项目概述

本项目是一个基于 RAG (Retrieval-Augmented Generation) 架构的医疗文档问答系统，采用模块化设计，实现了数据持久化、增量索引、服务层架构等核心改进。

## 二、技术栈

- **Web 框架**: Streamlit
- **向量数据库**: Milvus Standalone（Docker）
- **嵌入模型**: Sentence Transformers (all-MiniLM-L6-v2)
- **生成模型**: Hugging Face Transformers (GPT 系列模型，如 gpt2)
- **数据持久化**: SQLite
- **配置管理**: TOML + Pydantic
- **Python 版本**: 3.9+

## 三、项目结构

```
exp04-easy-rag-system/
├── app_improved.py          # 改进版主应用（推荐使用）
├── app.py                   # 原始应用（保留）
│
├── config_manager.py        # 配置管理模块（TOML + Pydantic）
├── config.toml              # TOML 配置文件
├── config.py                # 原始配置（保留）
│
├── database.py              # 文档元数据数据库（SQLite）
├── milvus_service.py        # Milvus 服务（增量索引）
├── milvus_utils.py          # 原始 Milvus 工具（保留）
│
├── services.py              # 服务层架构
│   ├── VectorStoreService   # 向量存储服务
│   ├── EmbeddingService     # 嵌入服务
│   ├── GenerationService    # 生成服务
│   ├── DocumentService      # 文档管理服务
│   └── RAGService           # RAG 核心服务
│
├── models_with_timeout.py   # 带超时的模型加载（推荐）
├── models.py                # 原始模型加载（保留）
│
├── security.py              # 安全性模块
│   ├── InputValidator       # 输入验证
│   ├── RateLimiter          # 频率限制
│   └── ResourceLimiter      # 资源限制
│
├── data_utils.py            # 数据工具
├── rag_core.py              # RAG 核心功能
├── convert_graphrag_multi.py# GraphRAG-Benchmark 数据转换工具（生成 processed_data.json）
│
├── data/                    # 数据目录
│   └── processed_data.json  # 处理后的数据文件
│
├── requirements.txt         # 依赖列表
├── run_improved.sh          # 启动脚本
└── setup.sh                 # 配置脚本
```

## 四、核心架构

### 4.1 配置管理层

**文件**: `config_manager.py`, `config.toml`

- 使用 TOML 格式统一管理配置
- Pydantic 进行配置验证和类型检查
- 支持环境变量覆盖
- 多环境配置支持

**配置项**:
- 模型配置（嵌入模型、生成模型）
- Milvus 配置（数据路径、索引参数）
- 数据配置（数据文件、最大索引数）
- 生成参数（temperature、top_p 等）
- 搜索配置（top_k、相似度阈值）
- 安全配置（频率限制、资源限制）

### 4.2 数据持久化层

**文件**: `database.py`

- SQLite 数据库存储文档元数据
- 替代内存中的 `id_to_doc_map`
- 支持文档的增删改查
- 索引状态管理
- 查询历史存储

**数据表**:
- `document_metadata`: 文档元数据
- `index_status`: 索引状态
- `query_history`: 查询历史

### 4.3 向量存储层

**文件**: `milvus_service.py`

- Milvus Standalone（Docker）向量数据库
- 增量索引支持
- 自动创建和管理 collection
- 索引状态跟踪

### 4.4 服务层架构

**文件**: `services.py`

采用服务层设计，实现业务逻辑与 UI 分离：

1. **VectorStoreService**: 向量存储服务
   - 向量搜索
   - 相关性阈值过滤
   - 距离转相似度

2. **EmbeddingService**: 嵌入服务
   - 文本编码为向量
   - 批量编码支持

3. **GenerationService**: 生成服务
   - 基于上下文生成答案
   - 可配置生成参数

4. **DocumentService**: 文档管理服务
   - 文档的增删改查
   - 数据库和向量库同步

5. **RAGService**: RAG 核心服务
   - 整合所有服务
   - 端到端 RAG 流程
   - 性能监控

### 4.5 安全性层

**文件**: `security.py`

- **InputValidator**: 输入验证和清理
- **RateLimiter**: 频率限制（每分钟请求数）
- **ResourceLimiter**: 资源限制（并发数、超时）

### 4.6 应用层

**文件**: `app_improved.py`

- Streamlit Web 界面
- 实时进度显示
- 查询历史展示
- 性能指标可视化
- 数据管理界面

## 五、核心功能

### 5.1 数据管理

- ✅ **增量索引**: 只索引新增或变更的文档
- ✅ **数据持久化**: SQLite 存储，重启后无需重新索引
- ✅ **索引状态管理**: 跟踪每个文档的索引状态
- ✅ **批量操作**: 支持批量添加、删除、更新

### 5.2 搜索功能

- ✅ **向量相似度搜索**: 基于 Milvus 的快速检索
- ✅ **相关性阈值**: 过滤低质量结果
- ✅ **统一 API**: 修复兼容性问题
- ✅ **距离转相似度**: 提供更直观的相似度分数

### 5.3 生成功能

- ✅ **上下文生成**: 基于检索到的文档生成答案
- ✅ **可配置参数**: temperature、top_p、repetition_penalty
- ✅ **提示词工程**: 明确要求基于上下文回答

### 5.4 性能监控

- ✅ **详细指标**: 嵌入时间、搜索时间、检索时间、生成时间
- ✅ **性能可视化**: 在界面中显示各环节耗时
- ✅ **查询历史**: 自动记录查询和性能数据

### 5.5 安全性

- ✅ **输入验证**: 验证查询长度和格式
- ✅ **频率限制**: 防止请求过载
- ✅ **资源限制**: 限制并发数和超时
- ✅ **内容过滤**: 防止恶意输入

## 六、数据流

```
用户查询
    ↓
输入验证 (security.py)
    ↓
频率/资源检查 (security.py)
    ↓
生成查询向量 (EmbeddingService)
    ↓
向量搜索 (VectorStoreService)
    ↓
相关性过滤
    ↓
获取文档内容 (DocumentService)
    ↓
生成答案 (GenerationService)
    ↓
记录查询历史 (DocumentDatabase)
    ↓
返回结果
```

## 七、初始化流程

1. **加载配置** (`config_manager.py`)
   - 从 TOML 文件或环境变量加载配置
   - Pydantic 验证配置有效性

2. **初始化数据库** (`database.py`)
   - 创建 SQLite 数据库
   - 初始化表结构

3. **连接 Milvus** (`milvus_service.py`)
   - 初始化 Milvus 客户端
   - 创建或加载 collection

4. **加载模型** (`models_with_timeout.py`)
   - 加载嵌入模型（带超时检测）
   - 加载生成模型（带超时检测）
   - 显示实时进度

5. **初始化服务** (`services.py`)
   - 创建各服务实例
   - 组装 RAG 服务

## 八、关键改进

### 8.1 数据持久化
- 从内存存储改为 SQLite 数据库
- 支持应用重启后数据保留
- 支持多实例部署

### 8.2 增量索引
- 只索引新增文档，大幅提升效率
- 记录索引状态，避免重复索引

### 8.3 服务层架构
- 业务逻辑与 UI 分离
- 便于单元测试
- 支持功能扩展

### 8.4 配置管理
- 统一配置文件
- 类型安全验证
- 环境变量支持

### 8.5 安全性增强
- 完整的输入验证
- 频率和资源限制
- 超时机制

## 九、使用说明

### 9.1 安装依赖
```bash
pip install -r requirements.txt
```

### 9.2 配置系统
编辑 `config.toml` 或使用环境变量

### 9.3 运行应用
```bash
streamlit run app_improved.py
```

或使用启动脚本：
```bash
./run_improved.sh
```

### 9.4 数据索引
1. 准备数据文件（JSON 格式）
2. 在应用侧边栏点击"索引数据"
3. 等待索引完成

## 十、扩展性

### 10.1 替换向量数据库
- 实现 `VectorStoreService` 接口
- 修改 `milvus_service.py`

### 10.2 替换模型
- 修改 `config.toml` 中的模型名称
- 确保模型兼容接口

### 10.3 添加新功能
- 在 `services.py` 中添加新服务
- 在 `app_improved.py` 中集成 UI

## 十一、注意事项

1. **首次运行**: 需要下载模型，可能需要 5-10 分钟
2. **数据文件**: 需要准备 JSON 格式的数据文件
3. **数据库文件**: 首次运行会自动创建 SQLite 数据库
4. **模型缓存**: 模型会缓存到 `hf_cache/` 目录

---

**文档版本**: v1.0  
**最后更新**: 2025年

